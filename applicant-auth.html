<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Applicant Login / Register</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
</head>
<body>
    <div class="page">
        <div class="container" style="max-width: 480px; margin-top: 60px;">
            <div class="header" style="text-align: center; margin-bottom: 30px;">
                <h1>Business Owner / Applicant</h1>
                <p class="subtitle">Login or create your account</p>
            </div>

            <div class="card" style="padding: 24px;">
                <div style="display:flex; gap:8px; margin-bottom:20px;">
                    <button id="tabLogin" class="btn btn-secondary" style="flex:1;">Login</button>
                    <button id="tabRegister" class="btn btn-secondary" style="flex:1;">Register</button>
                </div>

                <form id="loginForm" class="auth-form">
                    <div class="form-group">
                        <label for="loginEmail">Email</label>
                        <input type="email" id="loginEmail" required>
                    </div>
                    <div class="form-group">
                        <label for="loginPassword">Password</label>
                        <input type="password" id="loginPassword" required>
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary" style="width:100%;">Login</button>
                    </div>
                </form>

                <form id="registerForm" class="auth-form" style="display:none;">
                    <div class="form-group">
                        <label for="regFirstName">First Name</label>
                        <input type="text" id="regFirstName" required>
                    </div>
                    <div class="form-group">
                        <label for="regMiddleName">Middle Name (optional)</label>
                        <input type="text" id="regMiddleName">
                    </div>
                    <div class="form-group">
                        <label for="regLastName">Last Name</label>
                        <input type="text" id="regLastName" required>
                    </div>
                    <div class="form-group">
                        <label for="regEmail">Email</label>
                        <input type="email" id="regEmail" required>
                    </div>
                    <div class="form-group">
                        <label for="regPassword">Password</label>
                        <input type="password" id="regPassword" required>
                    </div>
                    <div class="form-group">
                        <label for="regConfirmPassword">Confirm Password</label>
                        <input type="password" id="regConfirmPassword" required>
                    </div>
                    <div class="form-group" style="font-size: 12px; color: var(--text-secondary);">
                        Password must be at least 8 characters and include a capital letter, a number, and a special character.
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary" style="width:100%;">Create account</button>
                    </div>
                </form>

                <div style="margin:16px 0; text-align:center; color:var(--text-secondary); font-size:14px;">or</div>

                <div id="googleSignInContainer" style="display:flex; justify-content:center; margin-bottom:8px;"></div>
                <p style="font-size: 12px; color: var(--text-secondary); text-align:center;">
                    Uses your Gmail address to sign in as Applicant.
                </p>
            </div>

            <div style="text-align:center; margin-top:16px;">
                <a href="welcome.html" class="link">Back to role selection</a>
            </div>
        </div>
    </div>

    <script src="shared.js"></script>
    <script>
        const ROLE_KEY = 'auth_applicant_users';
        const SESSION_KEY = 'auth_session';

        function loadUsers() {
            try {
                return JSON.parse(localStorage.getItem(ROLE_KEY)) || [];
            } catch (e) {
                return [];
            }
        }

        function saveUsers(users) {
            localStorage.setItem(ROLE_KEY, JSON.stringify(users));
        }

        function validatePassword(password) {
            if (!password || password.length < 8) return false;
            if (!/[A-Z]/.test(password)) return false;
            if (!/[0-9]/.test(password)) return false;
            if (!/[^A-Za-z0-9]/.test(password)) return false;
            return true;
        }

        function setSession(user) {
            localStorage.setItem(SESSION_KEY, JSON.stringify({
                role: 'applicant',
                user: user
            }));
        }

        document.getElementById('tabLogin').addEventListener('click', function() {
            document.getElementById('loginForm').style.display = '';
            document.getElementById('registerForm').style.display = 'none';
        });

        document.getElementById('tabRegister').addEventListener('click', function() {
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('registerForm').style.display = '';
        });

        document.getElementById('registerForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const firstName = document.getElementById('regFirstName').value.trim();
            const middleName = document.getElementById('regMiddleName').value.trim();
            const lastName = document.getElementById('regLastName').value.trim();
            const email = document.getElementById('regEmail').value.trim().toLowerCase();
            const password = document.getElementById('regPassword').value;
            const confirmPassword = document.getElementById('regConfirmPassword').value;

            if (!firstName || !lastName) {
                alert('Please enter your first and last name.');
                return;
            }

            if (password !== confirmPassword) {
                alert('Passwords do not match.');
                return;
            }

            if (!validatePassword(password)) {
                alert('Password must be at least 8 characters and include a capital letter, a number, and a special character.');
                return;
            }

            const users = loadUsers();
            if (users.some(u => u.email === email)) {
                alert('An account with this email already exists. Please login instead.');
                return;
            }

            const fullName = (firstName + ' ' + (middleName ? middleName + ' ' : '') + lastName).trim();
            const newUser = { name: fullName, firstName, middleName, lastName, email, password, provider: 'local' };
            users.push(newUser);
            saveUsers(users);

            try {
                fetch('api/users.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        role: 'applicant',
                        name: fullName,
                        email: email,
                        password: password,
                        provider: 'local'
                    })
                }).catch(function() {});
            } catch (err) {}

            alert('Account created. You can now login.');
            document.getElementById('tabLogin').click();
        });

        document.getElementById('loginForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value.trim().toLowerCase();
            const password = document.getElementById('loginPassword').value;

            const users = loadUsers();
            const user = users.find(u => u.email === email && u.password === password);
            if (!user) {
                alert('Invalid email or password.');
                return;
            }

            setSession(user);
            window.location.href = 'applicant.html';
        });

        window.handleApplicantCredentialResponse = function (response) {
            // NOTE: In production, verify this token on the server.
            try {
                const payload = JSON.parse(atob(response.credential.split('.')[1]));
                const email = (payload.email || '').toLowerCase();
                const name = payload.name || payload.given_name || 'Applicant';

                let users = loadUsers();
                let user = users.find(u => u.email === email);
                if (!user) {
                    user = { name, email, password: null, provider: 'google' };
                    users.push(user);
                    saveUsers(users);

                    try {
                        fetch('api/users.php', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                role: 'applicant',
                                name: name,
                                email: email,
                                password: null,
                                provider: 'google'
                            })
                        }).catch(function() {});
                    } catch (err) {}
                }
                setSession(user);
                window.location.href = 'applicant.html';
            } catch (e) {
                console.error('Google sign-in failed', e);
                alert('Google sign-in failed.');
            }
        };

        window.onload = function () {
            if (window.google && google.accounts && google.accounts.id) {
                google.accounts.id.initialize({
                    client_id: 'YOUR_GOOGLE_CLIENT_ID_HERE',
                    callback: handleApplicantCredentialResponse
                });
                google.accounts.id.renderButton(
                    document.getElementById('googleSignInContainer'),
                    { theme: 'outline', size: 'large', width: 300 }
                );
            }
        };
    </script>
</body>
</html>
